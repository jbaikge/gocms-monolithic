<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Class Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <style type="text/css">
      @media (min-width: 992px) {
        main > aside {
          width: 24ch;
          min-height: 100vh;
          flex-shrink: 0;
        }
      }
      .class-fields:empty::after {
        background-color: var(--bs-secondary);
        color: var(--bs-light);
        text-align: center;
        content: 'Drag fields here';
        padding: 1em 0;
      }
      /*
      .class-fields li:not(:last-child)::after {
        display: block;
        content: '';
        border-bottom: 1px solid var(--bs-secondary);
        padding-top: 1rem;
      }
      */
      .sortable-ghost {
        opacity: 0.5;
      }
      .sortable-handle {
        background-color: var(--bs-secondary);
        color: var(--bs-light);
        padding: 0 3px;
        align-items: center;
        cursor: grab;
      }
    </style>
  </head>
  <body>
    <main class="d-lg-flex">
      <aside class="text-light bg-dark p-3">
        <div>GoCMS</div>
        <nav>
          <ul class="list-unstyled">
            <li>
              <a href="#" class="link-primary align-items-center collapsed" data-bs-toggle="collapse" data-bs-target="#class-collapse" aria-expanded="true">Classes</a>
              <ul class="list-unstyled small collapse ps-3" id="class-collapse">
                <li><a href="#" class="link-secondary">New Class</a></li>
              </ul>
            </li>
          </ul>
        </nav>
      </aside>
      <article class="flex-grow-1 p-3">
        <h1 class="fs-2 mb-3">My Class Fields</h1>
        <form method="post">
          <ul id="class-fields" class="list-unstyled d-grid gap-3 class-fields"><!-- No spaces so :empty triggers --></ul>
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </article>
      <aside class="bg-dark text-secondary p-3">
        <ul id="field-types" class="list-unstyled d-grid gap-3"><!-- See FieldTypeBuilder for populating this --></ul>
      </aside>
    </main>
    <div id="templates">
      <template id="field-type-template">
        <li class="d-grid" data-template="${template}" data-type="${type}" data-label="${label}"><button class="btn btn-secondary">${label}</button></li>
      </template>
      <template id="item-template">
        <div class="d-flex">
          <div class="d-flex sortable-handle">::</div>
          <div class="flex-grow-1 mx-3 field-definition">
            <h2 class="fs-5">${label}</h2>
            <input type="hidden" name="types[]" value="${type}">
            <input type="hidden" name="fields[]" value="${id}">
          </div>
          <div class="d-flex align-items-start">
            <button type="button" class="btn btn-close" tabindex="-1" aria-label="Remove" data-target="item-${uuid}"></button>
          </div>
        </div>
      </template>
      <template id="common-template">
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="form-floating">
              <input type="text" id="${id}-label" class="form-control mb-3" name="data[${id}][label]" placeholder="Field Label" value="" required>
              <label for="${id}-label">Field Label</label>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="form-floating">
              <input type="text" id="${id}-name" class="form-control mb-3" name="data[${id}][name]" placeholder="Field Name" pattern="[a-z0-9_]+" title="Must be lowercase alphanumeric; underscores allowed" value="" required>
              <label for="${id}-name">Field Name</label>
            </div>
          </div>
        </div>
      </template>
      <template id="date-template">
        <div class="row g-3">
          <div class="col-lg-3">
            <div class="form-floating">
              <input type="date" id="${id}-min" class="form-control mb-3" name="data[${id}][min]" placeholder="Min Date" value="">
              <label for="${id}-min">Min Date</label>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="form-floating">
              <input type="date" id="${id}-max" class="form-control mb-3" name="data[${id}][max]" placeholder="Max Date" value="">
              <label for="${id}-max">Max Date</label>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="form-floating">
              <input type="number" id="${id}-step" class="form-control mb-3" name="data[${id}][step]" min="0" placeholder="Step (seconds)" value="">
              <label for="${id}-step">Step (seconds)</label>
            </div>
          </div>
        </div>
      </template>
      <template id="time-template">
        <div class="row g-3">
          <div class="col-lg-3">
            <div class="form-floating">
              <input type="time" id="${id}-min" class="form-control mb-3" name="data[${id}][min]" placeholder="Min Time" value="">
              <label for="${id}-min">Min Time</label>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="form-floating">
              <input type="time" id="${id}-max" class="form-control mb-3" name="data[${id}][max]" placeholder="Max Time" value="">
              <label for="${id}-max">Max Time</label>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="form-floating">
              <input type="number" id="${id}-step" class="form-control mb-3" name="data[${id}][step]" min="0" placeholder="Step (seconds)" value="">
              <label for="${id}-step">Step (seconds)</label>
            </div>
          </div>
        </div>
      </template>
      <template id="number-template">
        <div class="row g-3">
          <div class="col-lg-3">
            <div class="form-floating">
              <input type="number" id="${id}-min" class="form-control mb-3" name="data[${id}][min]" placeholder="Min Number" value="">
              <label for="${id}-min">Min Number</label>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="form-floating">
              <input type="number" id="${id}-max" class="form-control mb-3" name="data[${id}][max]" placeholder="Max Number" value="">
              <label for="${id}-max">Max Number</label>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="form-floating">
              <input type="number" id="${id}-step" class="form-control mb-3" name="data[${id}][step]" min="0" placeholder="Step" value="">
              <label for="${id}-step">Step</label>
            </div>
          </div>
        </div>
      </template>
      <template id="select-template">
        <div class="row g-3">
          <div class="col-lg-12">
            <div class="form-floating">
              <textarea id="${id}-options" class="form-control mb-3" name="data[${id}][options]" placeholder="Options (one per line, key | value or just value)" style="height: 10em;"></textarea>
              <label for="${id}-options">Options (one per line, key | value or just value)</label>
            </div>
          </div>
        </div>
      </template>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@latest/dist/umd/uuidv4.min.js"></script>
    <script>
      const Replacer = (function(open, close) {
        'use strict';

        // Replaces all occurrences of keys wrapped in open and close tags with
        // values from replacements object
        const text = function(text, replacements) {
          for (const key in replacements) {
            const search = open + key + close;
            text = text.replaceAll(search, replacements[key]);
          }
          return text;
        };

        // Walks the node tree and replaces all tags within text nodes as well
        // as attributes
        const tree = function(node, replacements) {
          const walker = document.createTreeWalker(node, NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT);
          for (let current = walker.currentNode; current != null; current = walker.nextNode()) {
            if (current.nodeType == Node.TEXT_NODE) {
              current.textContent = this.text(current.textContent, replacements);
            }
            if (current.nodeType == Node.ELEMENT_NODE && current.hasAttributes()) {
              for (let attr of current.attributes) {
                attr.value = this.text(attr.value, replacements);
              }
            }
          }
        };

        return {
          text: text,
          tree: tree,
        };
      })('${', '}');
    </script>
    <script>
      const FieldTypeBuilder = (function() {
        'use strict';

        const templateId = 'field-type-template';

        const buildNode = function(definition) {
          const template = document.getElementById(templateId);
          if (template == null) {
            console.error('Could not find template %s', templateId);
            return document.createElement('li');
          }

          const node = template.content.cloneNode(true);
          Replacer.tree(node, definition);
          return node;
        }

        // Generates nodes from definitions array.
        // Definitions array should contain objects with the keys:
        // * type
        // * template
        // * label
        const create = function(node, definitions) {
          for (let i = 0; i < definitions.length; i++) {
            const definition = definitions[i];
            node.appendChild(buildNode(definition));
          }
        };

        return {
          create: create,
        };
      })()
    </script>
    <script>
      const fieldTypeDefinitions = [
        {
          type:     'date',
          template: 'date',
          label:    'Date',
        },
        {
          type:     'datetime-local',
          template: 'date',
          label:    'Date & Time',
        },
        {
          type:     'email',
          template: 'email',
          label:    'Email',
        },
        {
          type:     'multi-select',
          template: 'select',
          label:    'Multi-Select',
        },
        {
          type:     'number',
          template: 'number',
          label:    'Number',
        },
        {
          type:     'select',
          template: 'select',
          label:    'Select',
        },
        {
          type:     'text',
          template: 'text',
          label:    'Text',
        },
        {
          type:     'textarea',
          template: 'textarea',
          label:    'Textarea',
        },
        {
          type:     'time',
          template: 'time',
          label:    'Time',
        },
        {
          type:     'tinymce',
          template: 'tinymce',
          label:    'TinyMCE',
        },
      ];

      const fieldTypes = document.getElementById('field-types');
      FieldTypeBuilder.create(fieldTypes, fieldTypeDefinitions);

      const fieldTypesOptions = {
        group: {
          name: 'field-types',
          pull: 'clone',
        },
        sort: false, // Disable sorting as we only want to pull from this list
      };
      Sortable.create(fieldTypes, fieldTypesOptions);

      const classFields = document.getElementById('class-fields');
      const classFieldsOptions = {
        group: {
          name: 'class-fields',
          put: 'field-types',
        },
        animation: 150,
        emptyInsertThreshold: 20, // defaults to 5
        handle: '.sortable-handle',
        onAdd: function(event) {
          // Pull in templates and build the form fields
          const item = document.getElementById('item-template').content.cloneNode(true);
          event.item.replaceChildren(item);

          const definition = event.item.querySelector('.field-definition');

          const common = document.getElementById('common-template').content.cloneNode(true);
          definition.appendChild(common);

          const template = document.getElementById(event.item.dataset.template + '-template');
          if (template != null) {
            definition.appendChild(template.content.cloneNode(true));
          }

          // Build the replacements to handle ${var} in attributes and text
          const uuid = uuidv4();
          const replacements = {
            'uuid':  uuid,
            'id':    'field-' + uuid,
            'label': event.item.dataset.label,
            'type':  event.item.dataset.type,
          };
          Replacer.tree(event.item, replacements);

          // Set up the close button
          event.item.setAttribute('id', 'item-' + uuid);
          event.item.querySelector('button.btn-close').addEventListener('click', function(event) {
            event.preventDefault();
            const item = document.getElementById(event.target.dataset.target);
            item.parentNode.removeChild(item);
          });
        },
      };
      Sortable.create(classFields, classFieldsOptions);
    </script>
  </body>
</html>
