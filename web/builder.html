<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Class Builder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <style type="text/css">
      @media (min-width: 992px) {
        main > aside {
          width: 24ch;
          min-height: 100vh;
          flex-shrink: 0;
        }
      }
      .class-fields:empty::after {
        background-color: var(--bs-secondary);
        color: var(--bs-light);
        text-align: center;
        content: 'Drag fields here';
        padding: 1em 0;
      }
      .class-fields li:not(:last-child)::after {
        display: block;
        content: '';
        border-bottom: 1px solid var(--bs-secondary);
        padding-top: 1rem;
      }
      .sortable-ghost {
        opacity: 0.5;
      }
      .sortable-handle {
        background-color: var(--bs-secondary);
        color: var(--bs-light);
        padding: 0 3px;
        align-items: center;
        cursor: grab;
      }
    </style>
  </head>
  <body>
    <main class="d-lg-flex">
      <aside class="text-light bg-dark p-3">
        <div>GoCMS</div>
        <nav>
          <ul class="list-unstyled">
            <li>
              <a href="#" class="link-primary align-items-center collapsed" data-bs-toggle="collapse" data-bs-target="#class-collapse" aria-expanded="true">Classes</a>
              <ul class="list-unstyled small collapse ps-3" id="class-collapse">
                <li><a href="#" class="link-secondary">New Class</a></li>
              </ul>
            </li>
          </ul>
        </nav>
      </aside>
      <article class="flex-grow-1 p-3">
        <h1 class="fs-2 mb-3">My Class Fields</h1>
        <form method="post">
          <ul id="class-fields" class="list-unstyled d-grid gap-3 class-fields"><!-- No spaces so :empty triggers --></ul>
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </article>
      <aside class="bg-dark text-secondary p-3">
        <ul id="field-types" class="list-unstyled d-grid gap-3">
          <li class="d-grid" data-template="date" data-type="date" data-label="Date"><button class="btn btn-secondary">Date</button></li>
          <li class="d-grid" data-template="date" data-type="datetime-local" data-label="Date &amp; Time"><button class="btn btn-secondary">Date &amp; Time</button></li>
          <li class="d-grid" data-template="email" data-type="email" data-label="Email"><button class="btn btn-secondary">Email</button></li>
          <li class="d-grid" data-template="select" data-type="multiselect" data-label="Multi-Select"><button class="btn btn-secondary">Multi-Select</button></li>
          <li class="d-grid" data-template="number" data-type="number" data-label="Number"><button class="btn btn-secondary">Number</button></li>
          <li class="d-grid" data-template="select" data-type="select" data-label="Select"><button class="btn btn-secondary">Select</button></li>
          <li class="d-grid" data-template="text" data-type="text" data-label="Text"><button class="btn btn-secondary">Text</button></li>
          <li class="d-grid" data-template="textarea" data-type="textarea" data-label="Textarea"><button class="btn btn-secondary">Textarea</button></li>
          <li class="d-grid" data-template="date" data-type="time" data-label="Time"><button class="btn btn-secondary">Time</button></li>
          <li class="d-grid" data-template="tinymce" data-type="tinymce" data-label="TinyMCE"><button class="btn btn-secondary">TinyMCE</button></li>
        </ul>
      </aside>
    </main>
    <div id="templates">
      <template id="item-template">
        <div class="d-flex">
          <div class="d-flex sortable-handle">::</div>
          <div class="flex-grow-1 mx-3 field-definition">
            <h2 class="fs-5">${label}</h2>
            <input type="hidden" name="ids[]" value="${uuid}">
          </div>
          <div class="d-flex align-items-start">
            <button type="button" class="btn btn-close" aria-label="Remove" data-target="item-${uuid}"></button>
          </div>
        </div>
      </template>
      <template id="common-template">
        <div class="row">
          <div class="col-lg-6">
            <div class="form-floating">
              <input type="text" id="${id}-label" class="form-control" name="label[${id}]" value="" placeholder="Field Label" required>
              <label for="${id}-label">Field Label</label>
            </div>
          </div>
        </div>
      </template>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@latest/dist/umd/uuidv4.min.js"></script>
    <script>
      const fieldTypes = document.getElementById('field-types');
      const fieldTypesOptions = {
        group: {
          name: 'field-types',
          pull: 'clone',
        },
        sort: false, // Disable sorting as we only want to pull from this list
      };
      Sortable.create(fieldTypes, fieldTypesOptions);

      const classFields = document.getElementById('class-fields');
      const classFieldsOptions = {
        group: {
          name: 'class-fields',
          put: 'field-types',
        },
        animation: 150,
        emptyInsertThreshold: 20, // defaults to 5
        handle: '.sortable-handle',
        onAdd: function(event) {
          // Pull in templates and build the form fields
          const item = document.getElementById('item-template').content.cloneNode(true);
          event.item.replaceChildren(item);

          const definition = event.item.querySelector('.field-definition');

          const common = document.getElementById('common-template').content.cloneNode(true);
          definition.appendChild(common);

          const template = document.getElementById(event.item.dataset.template + '-template');
          if (template != null) {
            definition.appendChild(template.content.cloneNode(true));
          }

          // Build the replacements to handle ${var} in attributes and text
          const uuid = uuidv4();
          const replacements = {
            'uuid':  uuid,
            'id':    'field-' + uuid,
            'label': event.item.dataset.label,
            'type':  event.item.dataset.type,
          };
          const replacer = Replacer.create(replacements);

          // Walk the nodes and their attributes to replace variables
          const walker = document.createTreeWalker(event.item, NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT);
          for (let current = walker.currentNode; current != null; current = walker.nextNode()) {
            if (current.nodeType == Node.TEXT_NODE) {
              current.textContent = replacer.replace(current.textContent);
            }
            if (current.nodeType == Node.ELEMENT_NODE && current.hasAttributes()) {
              for (let attr of current.attributes) {
                attr.value = replacer.replace(attr.value);
              }
            }
          }

          // Set up the close button
          event.item.setAttribute('id', 'item-' + uuid);
          event.item.querySelector('button.btn-close').addEventListener('click', function(event) {
            event.preventDefault();
            const item = document.getElementById(event.target.dataset.target);
            item.parentNode.removeChild(item);
          });
        },
      };
      Sortable.create(classFields, classFieldsOptions);

      const Replacer = (function() {
        const create = function(replacements) {
          const replace = function(text) {
            for (let key in replacements) {
              const search = '${' + key + '}';
              text = text.replaceAll(search, replacements[key]);
            }
            return text;
          };

          return {
            replace: replace,
          };
        };

        return {
          create: create,
        }
      })();
    </script>
  </body>
</html>
